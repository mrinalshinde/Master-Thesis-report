\chapter{Normalized Measurements}\label{chap:normalized}
This chapter explains the procedure for normalized measurements. The first section gives a layout for both hardware and software implementation of the normalized measurements and is followed by a short explanation to \acs{EIRP} measurement. Then the next section defines the link budget for this approach. The fourth section demonstrates the normalization procedure. Following this explains the optimization of the antenna pair. The final section illustrates the program for the selection of the best-required probe antennas.


\section{Implementation}
The flow chart in Figure \ref{fig:1} explains the procedure for normalized measurements. Each step in the flow chart is further explained in detail in the further sections of this chapter. For the normalization measurements, the first step is to find the \acs{EIRP} of the \acs{DUT}. This can be done by a conducted measurement or by simply measuring the \acs{EIRP} in an \acf{AC}. The later provides us with the radiation pattern of the \acs{DUT}.  The \acs{EIRP} measurement is just done once for each \acs{DUT} and the results are normalized using this \acs{EIRP} value of the \acs{DUT}. Before performing the normalized measurements, it is important to find the best configuration for the cables and connections. This step is also done only once and all other measurements are done using the same configuration of the instruments and cables. This step also includes the calibration of all the cables within the system.  The section \ref{sec:opti} explains the above procedure.

\begin{figure}[H]
\centering
\includegraphics[scale = 0.6]{normflowchart.pdf}
\caption{Flowchart explaining the novel approach for wireless coexistence testing}
\label{fig:1} 
\end{figure}

The second block (2) in the flow chart \ref{fig:1} is explained in the section called Normalization. This procedure is vital for these measurements. This step is done every time a new test is run. Sometimes, long term measurements are done so that the \acf{MU} for the particular test case can be evaluated. This step then is performed at the beginning of the long term measurement and therefore the resulting coupling loss is used for all the measurement times during that long term measurement. \\
 
The selection of the best antenna probe depends mainly on the test case specification. For example, the companion device and the spectrum analyzer is used for \acf{OBW} measurement and \acf{PSD} measurement. And, the \acf{RxBlocking} test case uses the companion device along with the signal generator. Each instrument usually is confined to 2 antenna ports due to the internal block diagram of the switching module (explained in section \ref{sec:wn}). The procedure for the selection is explained in the subtopic called the selection of the best probe antenna. The measurement is run after all the mentioned steps. To get a good idea of the \acf{MU}, each test measurement is run several times, and the mean and standard deviation is computed. \\

This section also gives a brief overview of the implementation of the developed MATLAB\textregistered{} tool. The figure shows the individual steps of the measurement process implemented in this thesis.

\begin{figure}[H]
\centering
\includegraphics[scale = 0.6]{arrow.pdf}
\caption{Flow of the automation software}
\label{fig:2} 
\end{figure}

The software tool for automated wireless coexistence measurement is implemented in MATLAB\textregistered{} because of several reasons. MATLAB\textregistered{} is a numerical computing environment and fourth-generation programming language allowing matrix manipulations, plotting of acquired data, implementation, and testing of algorithms (e.g. for signal processing and antenna radiation patterns). One big advantage of MATLAB\textregistered{} is the availability of commonly used functions that are already implemented in the MATLAB\textregistered{} environment. Additionally, there are many toolboxes available, which are either free or can be purchased from MathWorks or third party suppliers. \acs{RS}\textregistered{} has many of these additional toolboxes licensed, which reduces development time significantly. This is especially important when studying new approaches as in the case of this thesis.

\subsection{Hardware Design}
The steps for implementation of radiated measurements are explained as follows:
\begin{enumerate}
  \item Place the \acs{DUT} inside an \acf{AC} and measure the maximum \acs{EIRP} from the \acs{DUT}.
  \item Place the \acs{DUT} in the \acs{RF} shielded box and connect the instruments as shown in the block diagram.

\begin{figure}[H]
\centering
\includegraphics[scale = 0.1]{hwdesign.png}
\caption{Design for the implementation of the system}
\label{fig:3} 
\end{figure}

There are six probe antennas inside the \acs{RF} shielded box. They work in pairs of 2. i.e. 2 antennas for spectrum analyzer which is used for measuring the power, bandwidth, etc. 2 other antennas are used for injecting a signal which is used in case of receiver blocking or adaptivity test case. And finally, the last pair of antennas are used for communicating with the \acs{DUT} by the companion device.

\item Perform Normalization: Power, which is found by calculating the average of each burst of the \acs{DUT} signal and finding the maximum of all bursts, is measured at all six antennas. The difference between the measured \acs{EIRP} in step 1 and the power measured at each antenna is defined as the coupling loss for that particular path. This step is explained in detail in the next section.

\item Select the best probe antenna out of each pair of antennas depending on the different test cases. The best probe antenna is considered the one which has minimum coupling loss. This step is explained in section 6.5. 

\item Run a measurement from the decided test cases. The procedure for each test case is explained in chapter 4.

\end{enumerate}



\subsection{Software Design}
After the conducted measurement analysis was fundamentally veri?ed in the experimental setup, the software implementation was restructured. Since the complexity of the implementation grew over time, an object-oriented programming style is used in the current implementation to account for this development. The object-oriented design improves the understanding of the code because the structure represents the real nature of the data well.

When you create a class in MATLAB\textregistered{}, it is by default a value class. I prefer having to update objects by reference, therefore the class uses a handle class. We can make this a handle class by changing the first line to:
\begin{lstlisting}[language=MATLAB]
classdef testClass < handle
\end{lstlisting}
Also, you wouldn't necessarily need output arguments for the methods of the handle class which is one of the main reasons for using this class. 

\begin{figure}[H]
\centering
\includegraphics[scale = 0.55]{ClassDiagram.pdf}
\caption{UML Class Diagram}
\label{fig:cd} 
\end{figure}

The seven classes build the core of the developed software tool . For better overview and understanding some attributes and methods are omitted in this class diagram (Figure \ref{fig:cd}). Each of these classes is derived from the base class ?Handle?. The CAutomation class instantiates objects from all the other six classes. Five of those classes are the instruments used in this thesis, i.e., Spectrum Analyzer, Signal Generator, Connectivity Tester, two Switching modules, and the last class named CDUT, specifies the \acs{DUT} standard, operating frequency, bandwidth, \acs{EIRP}, and so on.

\section{\acs{EIRP} Measurement}
\acs{EIRP} is measured once for every \acs{DUT} used. This is done in a conducted manner. The Figure \ref{fig:Ng1} explains the implementation of this measurement. The \acs{DUT} is associated with the companion device via a \acs{WLAN} signaling mode. The \acs{DUT} is set to transmitter mode by configuring \acs{ICMP} packets on the companion device. The spectrum analyzer therefore, measures the power of the signal from the \acs{DUT}. The \acs{EIRP} is then measured using the formula \ref{eq:eirp}.
\begin{equation}
\mbox{EIRP}  = \mbox{Attenuation}_{\mbox{cable}} +\mbox{Antenna Gain} \label{eq:eirp}
\end{equation}
This measurement can also be done in an \acf{AC} and would give a better result by providing us the radiation pattern of the \acs{DUT} antenna.


\section{Normalization}
Normalization aims at finding the coupling loss at each antenna port. This data further aids in finding the best probe antenna. The steps for normalized measurement is explained as follows:
\begin{enumerate}
\item As mentioned in the section \ref{sec:wn}, the companion device is connected to the COMP1 port of the OSPWN. Therefore, switch the path between ANT1 and COMP1 and establish a \acs{WLAN} connection between the two devices (\acs{DUT} and the \acs{CMW}). 
\item Configure the Packet Generator (explained in section \ref{sec:obw}) on the companion device to measure the signal from the \acs{DUT}. This thesis focuses on using the CMW as a companion device but this will also work for using other companion devices (e.g. Access Point).
\item Switch paths in a loop: ANT 2 to OUT2, ANT 3 to OUT 3, and so on (refer to Figure \ref{fig:ospwn}). Save the trace of the signal for each path from the \acs{DUT} by using the spectrum analyzer. Thus, we get the traces for ANT 2 to ANT5 ports.
\item To measure the signal at ANT1, switch path ANT2 to COMP1 and save the trace at ANT1. Attenuation for each path inside each switching module is taken from the calibration files provided with the switching modules. The coupling loss is measured using the equation \ref{eq:bl}.
\begin{equation}
\mbox{Power}_{\mbox{analyzer}}  = \mbox{EIRP} - \mbox{Coupling Loss} - \mbox{Attenuation}_{\mbox{total}}  \label{eq:bl}
\end{equation}
\end{enumerate}
The total attenuation comprises attenuation within the switching modules as well as the attenuation from the cables. The coupling loss accounts for the free space path loss, antenna gain, and polarization mismatch. The post- processing required to measure the power from the trace acquired at the spectrum analyzer and the link budget to calculate the power required at the signal generator is explained with the help of an example in the following sub-section \ref{sec:abc}.

\subsection{Post Processing for Power measurement} \label{sec:abc}
For each power measurement for each antenna, 20 traces are saved. The measurement is done in the time domain (i.e. zero span) because a single frequency is of interest to us and also due to the very low duty cycle of the signal from the \acs{DUT}. The purpose of the zero span is to specifically turn off the sweep function, as the sweep sometimes really screws up the measurement. If you have a pulsed source, if the pulse happens when the sweep is not on that one frequency, it misses the pulse power.
\begin{figure}[H]
  \centering
  \subfigure[Sweep time of 100ms]{\includegraphics[width=0.49\textwidth]{trace_100.png}} \label{fig:m}
  \centering
  \subfigure[Zoomed trace of Figure (a)]{\includegraphics[width=0.49\textwidth]{{trace_100_zoom.png}}} \\
   \subfigure[Sweep time of 20ms]{\includegraphics[width=0.49\textwidth]{trace_20.png}} \label{fig:n}
  \centering
  \subfigure[Zoomed trace of Figure (c)]{\includegraphics[width=0.49\textwidth]{{trace_20_zoom.png}}}
\caption{Trace}
\label{fig:rands}
\end{figure}


Each trace is as short as 20 ms. For each trace, the maximum power is found by taking the maximum of the average of each burst.  The burst detection is done due to the low duty cycle of the signal from the \acs{DUT}. Short trace is used because if the sweep time was increased e.g. to 100 ms then, there would be fewer points per burst to take an average. Since the sweep points considered are already maximum (32000), the only option remaining is to reduce the sweep time so that a better average can be done.  


\subsection{Link Budget} \label{sec:lb}
The link budget is necessary to design the complete end to an end measurement system. Consider receiver blocking measurement and hence we would require a blocking signal from the signal generator. Figure \ref{fig:link} explains the calculation of the levels within the system.

\begin{figure}[H]
\centering
\includegraphics[scale = 0.55]{link_budget.pdf}
\caption{Link Budget diagram}
\label{fig:link} 
\end{figure}

Suppose the calculated power (i.e. a maximum of an average of \acs{RMS} burst power) at the analyzer is -38 dBm, total attenuation (switching modules and cables) is 25 dB and maximum \acs{EIRP} is 15 dBm. Then, by using the formula from the previous section, the coupling loss at ANT 5 is 28 dB. According to the standard, receiver blocking measurement requires a blocker level of -47 dBm in front of the \acs{DUT} port. Then, to find the value of the level at the generator, we need to calculate backward. Therefore the value at the generator would be given by equation \ref{eq:BL}.
\begin{equation}
\mbox{Blocker Level}_{\mbox{generator}}  = \mbox{Blocker Level}_{\mbox{DUT}} + \mbox{Attenuation}_{\mbox{total}} + \mbox{Coupling Loss} \label{eq:BL}
\end{equation}
Antenna Gain is already taken care of since the standard defined the power levels in front of the \acs{DUT} Antenna. Assume that the attenuation for this path is 18 dB. Therefore, by using the above formula, the power at the generator is 1 dBm. Attenuations are frequency-dependent and for the coupling loss, we can only rely on the used frequencies of the \acs{DUT}. Nevertheless, for the paths within the switching modules and the cables, the available calibration data for the specific frequency is used. The exact value of attenuation could otherwise also be measured with the signal generator and the \acs{DUT} Antenna. As the blocker frequencies are not too far away (image of analyzer from chap 7 link) from the in-band frequencies, the same coupling loss is considered.

\section{Optimization of Antenna Pair}

\subsection{Simulation} 

\subsection{Actual Measurement} 

\section{Selection of Best Probe Antenna}
The selection of the best probe antenna for each device depends on the coupling loss and the measurement test case. Isolation between the used probe antennas could be an additional parameter that may be important but this thesis does not consider it. The presence of test leads (not associated with the DUT under normal operation) in the radiated field may cause a disturbance of that field and lead to additional measurement uncertainty. These disturbances can be minimized by using suitable coupling methods, offering signal isolation, and minimum field disturbance (e.g. optical coupling). \\

Receiver blocking requires a signal generator and a companion device. The companion device is connected to COMP1 of the switching module OSPWN (refer Figure \ref{fig:ospwn}) and hence only antenna 1 and antenna 2 can be used for the companion device. The one with lower coupling loss would be considered as the best probe antenna. For the signal generator, only antenna 5 and 6 can be used since these paths go to GEN W(8) of the OSPWN. Again the one with less coupling loss will be the best probe antenna. Similarly, \acf{OBW} and \acf{PSD} measurements require a companion device and the spectrum analyzer. The best probe antenna is selected for the companion device from antenna 1 and antenna 2. The analyzer can then use any of the five remaining antennas.



















